<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue JS</title>
    <style>
      .borde{
        border: 1px solid black;
        text-align: center;
      }
    </style>
</head>
<body>
    <h1>Actividad 18</h1>
    <div id="main" class="main">
      <form @submit.prevent="login" v-if="!access">
        <div>
          <label>Correo</label>
          <input type="text" v-model="email" placeholder="Correo aqui" required>
        </div>
        <div>
          <label>Contraseña</label>
          <input type="password" v-model="password" placeholder="Contraseña aqui" required>
        </div>
        <button type="login">Iniciar</button>
      </form>
      <div v-if="access">
        <h1>LISTA DE PELICULAS</h1>
        <div>
          <ul>
            <li v-for="movie in movies" :key="movie.id" class="borde">
              {{ movie.title }} ({{ movie.release_date }})
            </li>
          </ul>
        </div>
      </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, onMounted } = Vue

        createApp({
          setup() {
            let email = ref('jgomez_21')
            let password = ref('TW8xBjj!C2X2$nX')
            let access = ref(false)
            let movies = ref([])

            const session = localStorage.getItem("user_log")
            if (session) {
              access.value = true
              fetchMovies();  // Cargar películas si ya está logueado
            } 

            const fetchMovies = () => {
              const myHeaders = new Headers();
              myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJjMWJiNjZjYTgxNzA5NjZkMjFmMjI4ZWJmOWI0ZmI4NCIsIm5iZiI6MTcyNzIxNzg5MS40Njk3MDcsInN1YiI6IjY2ZjMxOGYzMDIyMDhjNjdjODhkYWM4MCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.vERnsTknlvRt_F-1AWya7XjpiQySFz2_1aSkq55Bqm0");
              
              const requestOptions = {
                method: 'GET',
                headers: myHeaders
              };

              fetch("https://api.themoviedb.org/3/discover/movie", requestOptions)
                .then(response => response.json())
                .then(data => {
                  movies.value = data.results;  // Guardar las películas en la variable movies
                })
                .catch(error => console.log('error', error));
            }

            const login = () => {
              const myHeaders = new Headers();
              myHeaders.append("Authorization", "Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJjMWJiNjZjYTgxNzA5NjZkMjFmMjI4ZWJmOWI0ZmI4NCIsIm5iZiI6MTcyNzIxNzg5MS40Njk3MDcsInN1YiI6IjY2ZjMxOGYzMDIyMDhjNjdjODhkYWM4MCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.vERnsTknlvRt_F-1AWya7XjpiQySFz2_1aSkq55Bqm0");
              myHeaders.append("Content-Type", "application/json");

              const raw = JSON.stringify({
                "username": email.value,
                "password": password.value,
                "request_token": ""
              });

              const requestOptions = {
                method: 'POST',
                headers: myHeaders,
                body: raw
              };

              fetch("https://api.themoviedb.org/3/authentication/token/validate_with_login", requestOptions)
                .then(response => response.json())
                .then(result => {
                  if (result.success) {
                    localStorage.setItem("user_log", JSON.stringify(result));
                    access.value = true;
                    fetchMovies();  // Cargar películas después del login
                  } else {
                    alert('Usuario o contraseña incorrectos');
                  }
                })
                .catch(error => console.log('error', error));
            }

            return {
              email,
              password,
              access,
              movies,
              login
            }
          }
        }).mount('#main')
    </script>
</body>
</html>
